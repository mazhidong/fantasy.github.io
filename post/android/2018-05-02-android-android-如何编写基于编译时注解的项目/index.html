<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Android 如何编写基于编译时注解的项目 - Fantasy Blogs</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Fantasy" />
  <meta name="description" content="一、概述 在Android应用开发中，我们常常为了提升开发效率会选择使用一些基于注解的框架，但是由于反射造成一定运行效率的损耗，所以我们会更青" />

  <meta name="keywords" content="mzd, fantasy, blogs" />






<meta name="generator" content="Hugo 0.53" />


<link rel="canonical" href="https://mazhidong.github.io/post/android/2018-05-02-android-android-%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E5%9F%BA%E4%BA%8E%E7%BC%96%E8%AF%91%E6%97%B6%E6%B3%A8%E8%A7%A3%E7%9A%84%E9%A1%B9%E7%9B%AE/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.c8c1ff75dee09b44060a6c38f41b9036bac2512ccdb22d7f296cec12dc786375.css" integrity="sha256-yMH/dd7gm0QGCmw49BuQNrrCUSzNsi1/KWzsEtx4Y3U=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Android 如何编写基于编译时注解的项目" />
<meta property="og:description" content="一、概述 在Android应用开发中，我们常常为了提升开发效率会选择使用一些基于注解的框架，但是由于反射造成一定运行效率的损耗，所以我们会更青" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mazhidong.github.io/post/android/2018-05-02-android-android-%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E5%9F%BA%E4%BA%8E%E7%BC%96%E8%AF%91%E6%97%B6%E6%B3%A8%E8%A7%A3%E7%9A%84%E9%A1%B9%E7%9B%AE/" /><meta property="article:published_time" content="2018-05-02T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-05-02T00:00:00&#43;00:00"/>

<meta itemprop="name" content="Android 如何编写基于编译时注解的项目">
<meta itemprop="description" content="一、概述 在Android应用开发中，我们常常为了提升开发效率会选择使用一些基于注解的框架，但是由于反射造成一定运行效率的损耗，所以我们会更青">


<meta itemprop="datePublished" content="2018-05-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-05-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="4578">



<meta itemprop="keywords" content="android,注解," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android 如何编写基于编译时注解的项目"/>
<meta name="twitter:description" content="一、概述 在Android应用开发中，我们常常为了提升开发效率会选择使用一些基于注解的框架，但是由于反射造成一定运行效率的损耗，所以我们会更青"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Fantasy</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Fantasy
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mazhidong.github.io/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Android 如何编写基于编译时注解的项目</h1>
      
      <div class="post-meta">
        <time datetime="2018-05-02" class="post-time">
          2018-05-02
        </time>
        <div class="post-category">
            <a href="https://mazhidong.github.io/categories/android/"> android </a>
            
          </div>
        <span class="more-meta"> 约 4578 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#一-概述">一、概述</a></li>
<li><a href="#二-编写前的准备">二、编写前的准备</a></li>
<li><a href="#三-注解模块的实现">三、注解模块的实现</a></li>
<li><a href="#四-注解处理器的实现">四、注解处理器的实现</a>
<ul>
<li><a href="#1-基本代码">（1）基本代码</a></li>
<li><a href="#2-process的实现">（2）process的实现</a>
<ul>
<li><a href="#a-收集信息">a.收集信息</a></li>
<li><a href="#b-生成代理类">b.生成代理类</a></li>
<li><a href="#c-生成java代码">c.生成Java代码</a></li>
</ul></li>
</ul></li>
<li><a href="#五-api模块的实现">五、API模块的实现</a></li>
<li><a href="#六-总结">六、总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="一-概述">一、概述</h2>

<p>在Android应用开发中，我们常常为了提升开发效率会选择使用一些基于注解的框架，但是由于反射造成一定运行效率的损耗，所以我们会更青睐于编译时注解的框架，例如：</p>

<ul>
<li><a href="https://github.com/JakeWharton/butterknife">butterknife</a>免去我们编写View的初始化以及事件的注入的代码。</li>
<li><a href="https://github.com/greenrobot/EventBus">EventBus3</a>方便我们实现组建间通讯。</li>
<li><a href="https://github.com/sockeqwe/fragmentargs">fragmentargs</a>轻松的为fragment添加参数信息，并提供创建方法。</li>
<li><a href="https://github.com/baoyongzhang/ParcelableGenerator">ParcelableGenerator</a>可实现自动将任意对象转换为Parcelable类型，方便对象传输。</li>
</ul>

<p>类似的库还有非常多，大多这些的库都是为了自动帮我们完成日常编码中需要重复编写的部分（例如：每个Activity中的View都需要初始化，每个实现<code>Parcelable</code>接口的对象都需要编写很多固定写法的代码）。</p>

<p>这里并不是说上述框架就一定没有使用反射了，其实上述其中部分框架内部还是有部分实现是依赖于反射的，但是很少而且一般都做了缓存的处理，所以相对来说，效率影响很小。</p>

<p>但是在使用这类项目的时候，有时候出现错误会难以调试，主要原因还是很多用户并不了解这类框架其内部的原理，所以遇到问题时会消耗大量的时间去排查。</p>

<p>那么，于情于理，在编译时注解框架这么火的时刻，我们有理由去学习：</p>

<ul>
<li>如何编写一个机遇编译时注解的项目</li>
</ul>

<p>首先，是为了了解其原理，这样在我们使用类似框架遇到问题的时候，能够找到正确的途径去排查问题；其次，我们如果有好的想法，发现某些代码需要重复创建，我们也可以自己来写个框架方便自己日常的编码，提升编码效率；最后也算是自身技术的提升。</p>

<p>注：以下使用IDE为<code>Android Studio</code>.</p>

<p>本文将以编写一个View注入的框架为线索，详细介绍编写此类框架的步骤。</p>

<h2 id="二-编写前的准备">二、编写前的准备</h2>

<p>在编写此类框架的时候，一般需要建立多个module，例如本文即将实现的例子：</p>

<ul>
<li>ioc-annotation 用于存放注解等，Java模块</li>
<li>ioc-compiler 用于编写注解处理器，Java模块</li>
<li>ioc-api 用于给用户提供使用的API，本例为Andriod模块</li>
<li>ioc-sample 示例，本例为Andriod模块</li>
</ul>

<p>那么除了示例以为，一般要建立3个module，module的名字你可以自己考虑，上述给出了一个简单的参考。当然如果条件允许的话，有的开发者喜欢将存放注解和API这两个module合并为一个module。</p>

<p>对于module间的依赖，因为编写注解处理器需要依赖相关注解，所以：</p>

<blockquote>
<p>ioc-compiler依赖ioc-annotation</p>
</blockquote>

<p>我们在使用的过程中，会用到注解以及相关API</p>

<blockquote>
<p>所以ioc-sample依赖ioc-api；ioc-api依赖ioc-annotation</p>
</blockquote>

<h2 id="三-注解模块的实现">三、注解模块的实现</h2>

<p>注解模块，主要用于存放一些注解类，本例是模板butterknife实现View注入，所以本例只需要一个注解类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></pre></td>
<td class="lntd">
<pre class="chroma">@Retention(RetentionPolicy.CLASS)
@Target(ElementType.FIELD)
public @interface BindView
{
    int value();
}</pre></td></tr></table>
</div>
</div>
<p>我们设置的保留策略为Class，注解用于Field上。这里我们需要在使用时传入一个id，直接以value的形式进行设置即可。</p>

<p>你在编写的时候，分析自己需要几个注解类，并且正确的设置<code>@Target</code>以及<code>@Retention</code>即可。</p>

<h2 id="四-注解处理器的实现">四、注解处理器的实现</h2>

<p>定义完成注解后，就可以去编写注解处理器了，这块有点复杂，但是也算是有章可循的。</p>

<p>该模块，我们一般会依赖注解模块，以及可以使用一个<code>auto-service</code>库</p>

<p><code>build.gradle</code>的依赖情况如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">dependencies {
    compile &#39;com.google.auto.service:auto-service:1.0-rc2&#39;
    compile project (&#39;:ioc-annotation&#39;)
}</pre></td></tr></table>
</div>
</div>
<p><code>auto-service</code>库可以帮我们去生成<code>META-INF</code>等信息。</p>

<h3 id="1-基本代码">（1）基本代码</h3>

<p>注解处理器一般继承于<code>AbstractProcessor</code>，刚才我们说有章可循，是因为部分代码的写法基本是固定的，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></pre></td>
<td class="lntd">
<pre class="chroma">@AutoService(Processor.class)
public class IocProcessor extends AbstractProcessor{
    private Filer mFileUtils;
    private Elements mElementUtils;
    private Messager mMessager;
    @Override
    public synchronized void init(ProcessingEnvironment processingEnv){
        super.init(processingEnv);
        mFileUtils = processingEnv.getFiler();
        mElementUtils = processingEnv.getElementUtils();
        mMessager = processingEnv.getMessager();
    }
    @Override
    public Set&lt;String&gt; getSupportedAnnotationTypes(){
        Set&lt;String&gt; annotationTypes = new LinkedHashSet&lt;String&gt;();
        annotationTypes.add(BindView.class.getCanonicalName());
        return annotationTypes;
    }
    @Override
    public SourceVersion getSupportedSourceVersion(){
        return SourceVersion.latestSupported();
    }
    @Override
    public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv){
    }</pre></td></tr></table>
</div>
</div>
<p>在实现<code>AbstractProcessor</code>后，<code>process()</code>方法是必须实现的，也是我们编写代码的核心部分，后面会介绍。</p>

<p>我们一般会实现<code>getSupportedAnnotationTypes()</code>和<code>getSupportedSourceVersion()</code>两个方法，这两个方法一个返回支持的注解类型，一个返回支持的源码版本，参考上面的代码，写法基本是固定的。</p>

<p>除此以外，我们还会选择复写<code>init()</code>方法，该方法传入一个参数<code>processingEnv</code>,可以帮助我们去初始化一些父类类：</p>

<ul>
<li>Filer mFileUtils; 跟文件相关的辅助类，生成JavaSourceCode.</li>
<li>Elements mElementUtils;跟元素相关的辅助类，帮助我们去获取一些元素相关的信息。</li>
<li>Messager mMessager;跟日志相关的辅助类。</li>
</ul>

<p>这里简单提一下<code>Elemnet</code>，我们简单认识下它的几个子类，根据下面的注释，应该已经有了一个简单认知。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">Element 
  - VariableElement //一般代表成员变量
  - ExecutableElement //一般代表类中的方法
  - TypeElement //一般代表代表类
  - PackageElement //一般代表Package</pre></td></tr></table>
</div>
</div>
<h3 id="2-process的实现">（2）process的实现</h3>

<p>process中的实现，相比较会比较复杂一点，一般你可以认为两个大步骤：</p>

<ul>
<li>收集信息</li>
<li>生成代理类（本文把编译时生成的类叫代理类）</li>
</ul>

<p>什么叫收集信息呢？就是根据你的注解声明，拿到对应的Element，然后获取到我们所需要的信息，这个信息肯定是为了后面生成<code>JavaFileObject</code>所准备的。</p>

<p>例如本例，我们会针对每一个类生成一个代理类，例如<code>MainActivity</code>我们会生成一个<code>MainActivity$$ViewInjector</code>。那么如果多个类中声明了注解，就对应了多个类，这里就需要：</p>

<ul>
<li>一个类对象，代表具体某个类的代理类生成的全部信息，本例中为<code>ProxyInfo</code></li>
<li>一个集合，存放上述类对象（到时候遍历生成代理类），本例中为<code>Map&lt;String, ProxyInfo&gt;</code>，key为类的全路径。</li>
</ul>

<p>这里的描述有点模糊没关系，一会结合代码就好理解了。</p>

<h4 id="a-收集信息">a.收集信息</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></pre></td>
<td class="lntd">
<pre class="chroma">private Map&lt;String, ProxyInfo&gt; mProxyMap = new HashMap&lt;String, ProxyInfo&gt;();
@Override
public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv){
    mProxyMap.clear();
    Set&lt;? extends Element&gt; elements = roundEnv.getElementsAnnotatedWith(BindView.class);
    //一、收集信息
    for (Element element : elements){
        //检查element类型
        if (!checkAnnotationUseValid(element)){
            return false;
        }
        //field type
        VariableElement variableElement = (VariableElement) element;
        //class type
        TypeElement typeElement = (TypeElement) variableElement.getEnclosingElement();//TypeElement
        String qualifiedName = typeElement.getQualifiedName().toString();

        ProxyInfo proxyInfo = mProxyMap.get(qualifiedName);
        if (proxyInfo == null){
            proxyInfo = new ProxyInfo(mElementUtils, typeElement);
            mProxyMap.put(qualifiedName, proxyInfo);
        }
        BindView annotation = variableElement.getAnnotation(BindView.class);
        int id = annotation.value();
        proxyInfo.mInjectElements.put(id, variableElement);
    }
    return true;
}</pre></td></tr></table>
</div>
</div>
<p>首先我们调用一下<code>mProxyMap.clear();</code>，因为process可能会多次调用，避免生成重复的代理类，避免生成类的类名已存在异常。</p>

<p>然后，通过<code>roundEnv.getElementsAnnotatedWith</code>拿到我们通过<code>@BindView</code>注解的元素，这里返回值，按照我们的预期应该是<code>VariableElement</code>集合，因为我们用于成员变量上。</p>

<p>接下来for循环我们的元素，首先检查类型是否是<code>VariableElement</code>.</p>

<p>然后拿到对应的类信息<code>TypeElement</code>，继而生成<code>ProxyInfo</code>对象，这里通过一个<code>mProxyMap</code>进行检查，key为<code>qualifiedName</code>即类的全路径，如果没有生成才会去生成一个新的，<code>ProxyInfo</code>与类是一一对应的。</p>

<p>接下来，会将与该类对应的且被<code>@BindView</code>声明的<code>VariableElement</code>加入到<code>ProxyInfo</code>中去，key为我们声明时填写的id，即View的id。</p>

<p>这样就完成了信息的收集，收集完成信息后，应该就可以去生成代理类了。</p>

<h4 id="b-生成代理类">b.生成代理类</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></pre></td>
<td class="lntd">
<pre class="chroma">@Override
public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv){
    //...省略收集信息的代码，以及try,catch相关
    for(String key : mProxyMap.keySet()){
        ProxyInfo proxyInfo = mProxyMap.get(key);
        JavaFileObject sourceFile = mFileUtils.createSourceFile(
                proxyInfo.getProxyClassFullName(), proxyInfo.getTypeElement());
            Writer writer = sourceFile.openWriter();
            writer.write(proxyInfo.generateJavaCode());
            writer.flush();
            writer.close();
    }
    return true;
}</pre></td></tr></table>
</div>
</div>
<p>可以看到生成代理类的代码非常的简短，主要就是遍历我们的<code>mProxyMap</code>，然后取得每一个<code>ProxyInfo</code>，最后通过<code>mFileUtils.createSourceFile</code>来创建文件对象，类名为<code>proxyInfo.getProxyClassFullName()</code>，写入的内容为<code>proxyInfo.generateJavaCode()</code>.</p>

<p>看来生成Java代码的方法都在ProxyInfo里面。</p>

<h4 id="c-生成java代码">c.生成Java代码</h4>

<p>这里我们主要关注其生成Java代码的方式。
下面主要看生成Java代码的方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></pre></td>
<td class="lntd">
<pre class="chroma"><span class="err">#</span><span class="nx">ProxyInfo</span>
<span class="c1">//key为id，value为对应的成员变量
</span><span class="c1"></span><span class="nx">public</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nx">Integer</span><span class="p">,</span> <span class="nx">VariableElement</span><span class="p">&gt;</span> <span class="nx">mInjectElements</span> <span class="p">=</span> <span class="nx">new</span> <span class="nx">HashMap</span><span class="p">&lt;</span><span class="nx">Integer</span><span class="p">,</span> <span class="nx">VariableElement</span><span class="p">&gt;();</span>

<span class="nx">public</span> <span class="nx">String</span> <span class="nf">generateJavaCode</span><span class="p">(){</span>
    <span class="nx">StringBuilder</span> <span class="nx">builder</span> <span class="p">=</span> <span class="nx">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;package &#34;</span> <span class="o">+</span> <span class="nx">mPackageName</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;;\n\n&#34;</span><span class="p">);</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;import com.zhy.ioc.*;\n&#34;</span><span class="p">);</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;public class &#34;</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="nx">mProxyClassName</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34; implements &#34;</span> <span class="o">+</span> <span class="nx">SUFFIX</span> <span class="o">+</span> <span class="s">&#34;&lt;&#34;</span> <span class="o">+</span> <span class="nx">mTypeElement</span><span class="p">.</span><span class="nf">getQualifiedName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;&gt;&#34;</span><span class="p">);</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n{\n&#34;</span><span class="p">);</span>
    <span class="nf">generateMethod</span><span class="p">(</span><span class="nx">builder</span><span class="p">);</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n}\n&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">builder</span><span class="p">.</span><span class="nf">toString</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">private</span> <span class="nx">void</span> <span class="nf">generateMethod</span><span class="p">(</span><span class="nx">StringBuilder</span> <span class="nx">builder</span><span class="p">){</span>
     <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;public void inject(&#34;</span><span class="o">+</span><span class="nx">mTypeElement</span><span class="p">.</span><span class="nf">getQualifiedName</span><span class="p">()</span><span class="o">+</span><span class="s">&#34; host , Object object )&#34;</span><span class="p">);</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n{\n&#34;</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="nx">id</span> <span class="p">:</span> <span class="nx">mInjectElements</span><span class="p">.</span><span class="nf">keySet</span><span class="p">()){</span>
        <span class="nx">VariableElement</span> <span class="nx">variableElement</span> <span class="p">=</span> <span class="nx">mInjectElements</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">String</span> <span class="nx">name</span> <span class="p">=</span> <span class="nx">variableElement</span><span class="p">.</span><span class="nf">getSimpleName</span><span class="p">().</span><span class="nf">toString</span><span class="p">();</span>
        <span class="nx">String</span> <span class="kd">type</span> <span class="p">=</span> <span class="nx">variableElement</span><span class="p">.</span><span class="nf">asType</span><span class="p">().</span><span class="nf">toString</span><span class="p">()</span> <span class="p">;</span>

        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34; if(object instanceof android.app.Activity)&#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n{\n&#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;host.&#34;</span><span class="o">+</span><span class="nx">name</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34; = &#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="o">+</span><span class="kd">type</span><span class="o">+</span><span class="s">&#34;)(((android.app.Activity)object).findViewById(&#34;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s">&#34;));&#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n}\n&#34;</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;else&#34;</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n{\n&#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;host.&#34;</span><span class="o">+</span><span class="nx">name</span><span class="p">).</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34; = &#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="o">+</span><span class="kd">type</span><span class="o">+</span><span class="s">&#34;)(((android.view.View)object).findViewById(&#34;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s">&#34;));&#34;</span><span class="p">);</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n}\n&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="s">&#34;\n}\n&#34;</span><span class="p">);</span>
<span class="p">}</span></pre></td></tr></table>
</div>
</div>
<p>这里主要就是靠收集到的信息，拼接完成的代理类对象了，看起来会比较头疼，不过我给出一个生成后的代码，对比着看会很多。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></pre></td>
<td class="lntd">
<pre class="chroma"><span class="kn">package</span> <span class="nx">com</span><span class="p">.</span><span class="nx">zhy</span><span class="p">.</span><span class="nx">ioc_sample</span><span class="p">;</span>
<span class="kn">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">zhy</span><span class="p">.</span><span class="nx">ioc</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>
<span class="nx">public</span> <span class="nx">class</span> <span class="nx">MainActivity</span><span class="err">$$</span><span class="nx">ViewInjector</span> <span class="nx">implements</span> <span class="nx">ViewInjector</span><span class="p">&lt;</span><span class="nx">com</span><span class="p">.</span><span class="nx">zhy</span><span class="p">.</span><span class="nx">ioc_sample</span><span class="p">.</span><span class="nx">MainActivity</span><span class="p">&gt;{</span>
    <span class="err">@</span><span class="nx">Override</span>
    <span class="nx">public</span> <span class="nx">void</span> <span class="nf">inject</span><span class="p">(</span><span class="nx">com</span><span class="p">.</span><span class="nx">zhy</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">MainActivity</span> <span class="nx">host</span> <span class="p">,</span> <span class="nx">Object</span> <span class="nx">object</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">object</span> <span class="nx">instanceof</span> <span class="nx">android</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Activity</span><span class="p">){</span>
            <span class="nx">host</span><span class="p">.</span><span class="nx">mTv</span> <span class="p">=</span> <span class="p">(</span><span class="nx">android</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">TextView</span><span class="p">)(((</span><span class="nx">android</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Activity</span><span class="p">)</span><span class="nx">object</span><span class="p">).</span><span class="nf">findViewById</span><span class="p">(</span><span class="mi">2131492945</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
            <span class="nx">host</span><span class="p">.</span><span class="nx">mTv</span> <span class="p">=</span> <span class="p">(</span><span class="nx">android</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">TextView</span><span class="p">)(((</span><span class="nx">android</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">View</span><span class="p">)</span><span class="nx">object</span><span class="p">).</span><span class="nf">findViewById</span><span class="p">(</span><span class="mi">2131492945</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></table>
</div>
</div>
<p>这样对着上面代码看会好很多，其实就死根据收集到的成员变量（通过<code>@BindView</code>声明的），然后根据我们具体要实现的需求去生成java代码。</p>

<p>这里注意下，生成的代码实现了一个接口<code>ViewInjector&lt;T&gt;</code>，该接口是为了统一所有的代理类对象的类型，到时候我们需要强转代理类对象为该接口类型，调用其方法；接口是泛型，主要就是传入实际类对象，例如<code>MainActivity</code>，因为我们在生成代理类中的代码，实际上就是<code>实际类.成员变量</code>的方式进行访问，所以，使用编译时注解的成员变量一般都不允许<code>private</code>修饰符修饰（有的允许，但是需要提供getter,setter访问方法）。</p>

<p>这里采用了完全拼接的方式编写Java代码，你也可以使用一些开源库，来通过Java api的方式来生成代码，例如：</p>

<ul>
<li><a href="https://github.com/square/javapoet">javapoet</a>.</li>
</ul>

<blockquote>
<p>A Java API for generating .java source files.</p>
</blockquote>

<p>到这里我们就完成了代理类的生成，这里任何的注解处理器的编写方式基本都遵循着收集信息、生成代理类的步骤。</p>

<h2 id="五-api模块的实现">五、API模块的实现</h2>

<p>有了代理类之后，我们一般还会提供API供用户去访问，例如本例的访问入口是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma"> //Activity中
 Ioc.inject(Activity);
 //Fragment中，获取ViewHolder中
 Ioc.inject(this, view);</pre></td></tr></table>
</div>
</div>
<p>模仿了butterknife，第一个参数为宿主对象，第二个参数为实际调用<code>findViewById</code>的对象；当然在Actiivty中，两个参数就一样了。</p>

<ul>
<li>API一般如何编写呢？</li>
</ul>

<p>其实很简单，只要你了解了其原理，这个API就干两件事：</p>

<ul>
<li>根据传入的host寻找我们生成的代理类：例如<code>MainActivity-&gt;MainActity$$ViewInjector</code>。</li>
<li>强转为统一的接口，调用接口提供的方法。</li>
</ul>

<p>这两件事应该不复杂，第一件事是拼接代理类名，然后反射生成对象，第二件事强转调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></pre></td>
<td class="lntd">
<pre class="chroma">public class Ioc{
    public static void inject(Activity activity){
        inject(activity , activity);
    }
    public static void inject(Object host , Object root){
        Class&lt;?&gt; clazz = host.getClass();
        String proxyClassFullName = clazz.getName()+&#34;$$ViewInjector&#34;;
       //省略try,catch相关代码 
        Class&lt;?&gt; proxyClazz = Class.forName(proxyClassFullName);
        ViewInjector viewInjector = (com.zhy.ioc.ViewInjector) proxyClazz.newInstance();
        viewInjector.inject(host,root);
    }
}
public interface ViewInjector&lt;T&gt;{
    void inject(T t , Object object);
}</pre></td></tr></table>
</div>
</div>
<p>代码很简单，拼接代理类的全路径，然后通过<code>newInstance</code>生成实例，然后强转，调用代理类的inject方法。</p>

<p>这里一般情况会对生成的代理类做一下缓存处理，比如使用<code>Map</code>存储下，没有再生成，这里我们就不去做了。</p>

<p>这样我们就完成了一个编译时注解框架的编写。</p>

<h2 id="六-总结">六、总结</h2>

<p>本文通过具体的实例来描述了如何编写一个基于编译时注解的项目，主要步骤为：项目结构的划分、注解模块的实现、注解处理器的编写以及对外公布的API模块的编写。通过文本的学习应该能够了解基于编译时注解这类框架运行的原理，以及自己如何去编写这样一类框架。</p>

<p>*源码地址: <a href="https://github.com/hymanAndroid/ioc-apt-sample">https://github.com/hymanAndroid/ioc-apt-sample</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Fantasy</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-05-02</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://mazhidong.github.io/tags/android/">android</a>
          <a href="https://mazhidong.github.io/tags/%E6%B3%A8%E8%A7%A3/">注解</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/android/2018-05-02-android-abstractprocessor%E5%92%8Capt%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Android AbstractProcessor和apt环境配置</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/aosp/2018-04-26-android-usb-bug/">
            <span class="next-text nav-default">Android USB 冲突问题</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  <div class="post bg-white">
      <div id="comments-gitment"></div>
      <link rel="stylesheet" href="/lib/gitment/gitment-0.0.3.min.css">
        <script src="/lib/gitment/gitment-0.0.3.min.js"></script>
      <script type="text/javascript">
      const gitment = new Gitment({
        id: '2018-05-02-android-Android 如何编写基于编译时注解的项目.md',
        title: 'Android 如何编写基于编译时注解的项目',
        link: decodeURI(location.href),
        desc: '一、概述 在Android应用开发中，我们常常为了提升开发效率会选择使用一些基于注解的框架，但是由于反射造成一定运行效率的损耗，所以我们会更青',
        owner: 'mazhidong',
        repo: 'comments',
        oauth: {
          client_id: 'a7ad9d79ce4e98eabdc8',
          client_secret: '13ffc9363807f8929fe31ce5a7022fb8676dab45'
        }
      })
      gitment.render('comments-gitment')
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>
    </div>

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
  
    <a href="mailto:591888356@qq.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/mazhidong" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://mazhidong.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Fantasy
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
